import { combatants, saveData } from './state.js';
import { DND_SPELLS_DATA, DND_STATUSES, DEFAULT_AVATAR } from './constants.js';

import { combatants, spellCastingMode, setSpellMode } from './state.js';
import { DND_STATUSES, DND_SPELLS_DATA } from './constants.js';

// --- 1. –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø –ò –§–û–ù ---

export function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.getElementById(tabId + '-tab').classList.add('active');
}

export function changeBackground(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const url = e.target.result;
            document.getElementById('main-bg').style.backgroundImage = `url(${url})`;
            localStorage.setItem('dnd_bg', url);
        };
        reader.readAsDataURL(file);
    }
}

// --- 2. –û–°–ù–û–í–ù–û–ô –†–ï–ù–î–ï–† –°–ü–ò–°–ö–ê –ë–û–Ø ---

export function renderCombatList() {
    const list = document.getElementById('character-list');
    if (!list) return;
    list.innerHTML = '';
    const DEFAULT_AVATAR = 'https://i.imgur.com/83p7pId.png';
    
    combatants.forEach((unit, index) => {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–∑–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
        if (!unit.mods) unit.mods = { shield: false, cover: null };
        if (!unit.statuses) unit.statuses = [];
        if (!unit.activeSpells) unit.activeSpells = [];

        const bonus = (unit.mods.shield ? 2 : 0) + 
                      (unit.mods.cover === '1/2' ? 2 : 0) + 
                      (unit.mods.cover === '3/4' ? 5 : 0);
        const totalAC = (parseInt(unit.ac) || 0) + bonus;
        const isDead = (parseInt(unit.currentHp) <= 0);
        const isCaster = (spellCastingMode && spellCastingMode.casterIndex === index);

        const div = document.createElement('div');
        div.className = `character-card ${unit.type === 'monster' ? 'monster-card' : ''} ${isDead ? 'unit-dead' : ''} ${isCaster ? 'casting-source' : ''}`;
        div.id = `unit-${index}`;
        
        div.onclick = (e) => {
            if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT' && 
                !e.target.classList.contains('status-tag') && !e.target.closest('.spell-badge')) {
                selectUnit(index);
            }
        };

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∫–æ–Ω–æ–∫ —Å—Ç–∞—Ç—É—Å–æ–≤ –∏ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π
        const statusIcons = unit.statuses.map(s => 
            `<span class="status-tag" onclick="event.stopPropagation(); dndActions.toggleStatus(${index}, '${s}')">${s} <small>√ó</small></span>`
        ).join('');

        const spellIcons = unit.activeSpells.map((spell, sIdx) => `
            <div class="spell-badge" 
                 onclick="event.stopPropagation(); dndActions.removeSpell(${index}, ${sIdx});" 
                 onmouseenter="highlightCaster(${index}, ${sIdx})" 
                 onmouseleave="resetHighlights()"
                 title="–ó–∞–∫–ª–∏–Ω–∞—Ç–µ–ª—å: ${spell.casterName}">
                <img src="${spell.casterImg || DEFAULT_AVATAR}" class="mini-caster-avatar">
                <span class="spell-name-text">${DND_SPELLS_DATA[spell.name] || '‚ú®'} ${spell.name}</span>
                <small style="margin-left: 4px; font-weight: bold;">√ó</small>
            </div>`).join('');

        div.innerHTML = `
            <div class="avatar-container">
                <img src="${unit.img || DEFAULT_AVATAR}" class="avatar" onerror="this.src='${DEFAULT_AVATAR}';">
                <div class="ac-badge" onclick="event.stopPropagation(); dndActions.editBaseAC(${index})" title="${unit.acNote || '–ë–∞–∑–æ–≤–∞—è –∑–∞—â–∏—Ç–∞'}">
                    ${totalAC}
                    ${(unit.acNote && (unit.acNote.includes('–º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞') || unit.acNote.includes('–ë–ú'))) ? '<span class="pb-label">–ë–ú</span>' : ''}
                </div>
            </div>

            <div class="unit-info">
                <div class="name-row">
                    <strong>${unit.name}</strong>
                    <span class="init-value" onclick="event.stopPropagation(); dndActions.editInit(${index})" title="–ò–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞">${unit.init}</span>
                </div>
                
                <div class="status-container">
                    <div class="active-statuses">${statusIcons}${spellIcons}</div>
                    <button class="add-status-btn" onclick="event.stopPropagation(); toggleStatusMenu(${index})">‚úö –°–æ—Å—Ç–æ—è–Ω–∏–µ</button>
                    <div id="status-menu-${index}" class="status-dropdown" onclick="event.stopPropagation()"></div>
                </div>
            </div>

            <div class="right-controls-group">
                <div class="mod-buttons">
                    <button class="shield-btn ${unit.mods.shield ? 'active' : ''}" onclick="event.stopPropagation(); dndActions.toggleMod(${index}, 'shield')" title="–©–∏—Ç (+2 –ö–î)">üõ°Ô∏è</button>
                    <button class="shield-btn ${unit.mods.cover === '1/2' ? 'active' : ''}" onclick="event.stopPropagation(); dndActions.toggleMod(${index}, '1/2')" title="–£–∫—Ä—ã—Ç–∏–µ 1/2 (+2 –ö–î)">¬Ω</button>
                    <button class="shield-btn ${unit.mods.cover === '3/4' ? 'active' : ''}" onclick="event.stopPropagation(); dndActions.toggleMod(${index}, '3/4')" title="–£–∫—Ä—ã—Ç–∏–µ 3/4 (+5 –ö–î)">¬æ</button>
                </div>

                <div class="hp-heart-container" onclick="event.stopPropagation(); dndActions.editHP(${index})" onwheel="dndActions.changeHP(event, ${index})" title="${unit.hpNote || '–ó–¥–æ—Ä–æ–≤—å–µ'}">
                    <svg viewBox="0 0 32 32" class="hp-heart-svg">
                        <path d="M16,28.261c0,0-14-7.926-14-17.046c0-9.356,13.159-10.399,14,0.454c0.841-10.853,14-9.81,14-0.454 C30,20.335,16,28.261,16,28.261z" fill="#9e2121" stroke="#333" stroke-width="1"/>
                    </svg>
                    <div class="hp-text-overlay">
                        <span class="hp-current">${unit.currentHp}</span>
                        <span class="hp-divider-slash">/</span>
                        <span class="hp-max">${unit.maxHp}</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="clone-btn" onclick="event.stopPropagation(); dndActions.cloneUnit(${index})" title="–ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å">üëØ</button>
                    <button class="delete-btn" onclick="event.stopPropagation(); dndActions.deleteUnit(${index})" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                </div>
            </div>`;
        list.appendChild(div);
    });
}

// --- 3. –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–ï –° –ö–ê–†–¢–û–ß–ö–ê–ú–ò (–í–´–ë–û–† –ò –ü–û–î–°–í–ï–¢–ö–ê) ---

export function selectUnit(index) {
    if (spellCastingMode) {
        dndActions.applySpellEffect(spellCastingMode.casterIndex, index, spellCastingMode.spellName);
        setSpellMode(null);
        resetHighlights();
        document.querySelectorAll('.character-card').forEach(c => c.style.opacity = "1");
        return;
    }
    document.querySelectorAll('.character-card').forEach(card => card.classList.remove('selected'));
    const target = document.getElementById(`unit-${index}`);
    if (target) target.classList.add('selected');
}

export function highlightCaster(targetIndex, spellIndex) {
    const spell = combatants[targetIndex].activeSpells[spellIndex];
    const casterIndex = combatants.findIndex(u => u.name === spell.casterName);
    if (casterIndex !== -1) {
        const casterEl = document.getElementById(`unit-${casterIndex}`);
        if (casterEl) casterEl.classList.add('casting-source');
    }
}

export function resetHighlights() {
    document.querySelectorAll('.character-card').forEach(c => {
        c.classList.remove('casting-source');
    });
}

// --- 4. –ú–ï–ù–Æ –°–¢–ê–¢–£–°–û–í –ò –ë–ò–ë–õ–ò–û–¢–ï–ö–ò ---

export function toggleStatusMenu(index) {
    const menu = document.getElementById(`status-menu-${index}`);
    const card = document.getElementById(`unit-${index}`);
    
    document.querySelectorAll('.status-dropdown').forEach(m => m.style.display = 'none');
    document.querySelectorAll('.character-card').forEach(c => c.classList.remove('has-open-menu'));

    if (menu.style.display === 'grid') {
        menu.style.display = 'none';
        card.classList.remove('has-open-menu');
    } else {
        menu.style.display = 'grid';
        card.classList.add('has-open-menu');
        
        const spellsArray = Object.keys(DND_SPELLS_DATA);
        menu.innerHTML = `
            <div class="status-section-title">–°—Ç–∞—Ç—É—Å—ã</div>
            ${DND_STATUSES.map(s => `<div class="status-option" onclick="dndActions.toggleStatus(${index}, '${s}')">${s}</div>`).join('')}
            <div class="status-section-title">–ó–∞–∫–ª–∏–Ω–∞–Ω–∏—è / –ú–µ—Ç–∫–∏</div>
            ${spellsArray.map(s => `<div class="status-option spell-option" onclick="dndActions.startSpellCasting(${index}, '${s}')">${DND_SPELLS_DATA[s]} ${s}</div>`).join('')}
        `;
    }
}

export function displayMonsters(monsters) {
    const container = document.getElementById('monster-library-list');
    if (!container) return;
    container.innerHTML = '';
    
    monsters.forEach((item) => {
        const values = Object.values(item);
        const name = (item["–ò–º—è"] || values[0] || "–ú–æ–Ω—Å—Ç—Ä").replace(/'/g, "\\'");
        const hp = item["MaxHP"] || values[1] || "10";
        const ac = item["AC"] || values[2] || "10";
        const img = item["–§–æ—Ç–æ"] || values[4] || 'https://i.imgur.com/83p7pId.png';

        const div = document.createElement('div');
        div.className = 'library-item';
        div.innerHTML = `
            <div class="lib-info" onclick="dndActions.addMonsterToCombat('${name}', '${hp}', '${ac}', '${img}')">
                <img src="${img}" onerror="this.src='https://i.imgur.com/83p7pId.png'">
                <span>${name} <small>(AC: ${ac})</small></span>
            </div>
            <div class="lib-actions">
                <label class="btn-lib-upload">üì∑<input type="file" style="display:none" onchange="dndActions.uploadPhotoDirect('${name}', event, 'Enemies')"></label>
            </div>`;
        container.appendChild(div);
    });
}

export function displayHeroes(heroes) {
    const container = document.getElementById('hero-library-list');
    if (!container) return;
    container.innerHTML = '';
    
    heroes.forEach((item) => {
        const values = Object.values(item);
        const name = (item["–ò–º—è"] || values[0] || "–ì–µ—Ä–æ–π").replace(/'/g, "\\'");
        const hp = parseInt(item["MaxHP"] || values[1]) || 10;
        const img = item["–§–æ—Ç–æ"] || values[4] || 'https://i.imgur.com/83p7pId.png';
        const ac = parseInt(item["–ö–î"] || values[5]) || 10;

        const div = document.createElement('div');
        div.className = 'library-item';
        div.innerHTML = `
            <div class="lib-info" onclick="dndActions.addHeroToCombat('${name}', ${hp}, '${img}', ${ac})">
                <img src="${img}" onerror="this.src='https://i.imgur.com/83p7pId.png'">
                <span>${name} <small>(HP: ${hp}, AC: ${ac})</small></span>
            </div>
            <div class="lib-actions">
                <label class="btn-lib-upload">üì∑<input type="file" style="display:none" onchange="dndActions.uploadHeroPhotoDirect('${name}', event)"></label>
            </div>`;
        container.appendChild(div);
    });
}
